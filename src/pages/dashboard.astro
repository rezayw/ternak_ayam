---
import type { APIRoute } from "astro";
import { randomUUID } from "node:crypto";
import { db } from "@/lib/db";
import "../styles/design-system.css";
import "../styles/dashboard.css";

// Check if user is logged in
const cookies = Astro.cookies;
const sessionId = cookies.get("session")?.value;

let csrf = Astro.cookies.get("csrf")?.value;
if (!csrf) {
  csrf = randomUUID();
  Astro.cookies.set("csrf", csrf, {
    httpOnly: true,
    sameSite: "strict",
    secure: true,
    path: "/"
  });
}

if (!sessionId) {
  return Astro.redirect("/login");
}

// Get REAL data from database
const user = await db.user.findUnique({
  where: { id: sessionId },
  include: {
    files: true
  }
});

const role = user?.role || "USER";
const canInput = role !== "USER";
const canUpload = role !== "USER";
const isAdmin = role === "ADMIN";

const totalFiles = user?.files.length || 0;
const allUsers = await db.user.count();
const allFiles = await db.file.count();

// Get LATEST INPUT DATA from FarmData table
const latestFarmData = await db.farmData.findFirst({
  where: { userId: sessionId },
  orderBy: { date: "desc" }
});

// Calculate REAL statistics from database
const totalChickens = latestFarmData?.totalChickens || 0;
const todayEggs = latestFarmData?.eggsToday || 0;

// Hitung produktivitas dari data real
const productivity = (latestFarmData && latestFarmData.totalChickens > 0) ? 
  Math.min(Math.floor((todayEggs / latestFarmData.totalChickens) * 100), 100) :
  0;
---

<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Ternak Ayam</title>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="nav-shell">
      <div class="nav-brand">
        <img src="/images/logo.png" alt="Ternak Ayam logo" />
        <span>Ternak Ayam</span>
      </div>
      <div class="nav-links">
        {isAdmin && <a href="/admin/users">Kelola Users</a>}
        {canInput && <a href="/input-data">Input Data</a>}
        {canUpload && <a href="/upload">Upload</a>}
        <a href="/laporan">Laporan</a>
        <form method="POST" action="/api/auth/logout" style="display: inline;">
          <input type="hidden" name="csrf" value={csrf} />
          <button type="submit" class="btn btn-danger">Logout</button>
        </form>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
      <!-- Welcome Section -->
      <div class="welcome-grid">
        <div class="welcome">
          <h1>Selamat Datang di Dashboard!</h1>
          <p>Kelola peternakan ayam Anda dengan efisien dan produktif</p>
          {latestFarmData && (
            <p class="welcome-meta">
              Data terakhir diupdate: {new Date(latestFarmData.date).toLocaleDateString('id-ID')}
            </p>
          )}
          <div class="welcome-actions">
            {canInput ? (
              <a href="/input-data" class="btn btn-primary">Input Data</a>
            ) : (
              <span class="btn btn-secondary" style="opacity:0.6; cursor:not-allowed;">View-only</span>
            )}
            <a href="/laporan" class="btn btn-secondary">Lihat Laporan</a>
          </div>
        </div>
        <div class="welcome-visual">
          <img src="/images/hero-dashboard-ternak-ayam.png" alt="Ilustrasi dashboard peternakan ayam" loading="lazy" />
          <div class="welcome-badge">Monitoring, keamanan data, multi-user</div>
        </div>
      </div>

      <!-- Statistics -->
      <div class="stats-grid">
        <div class="glass-card">
          <h3>Total Ayam</h3>
          <div class="stat-value">{totalChickens}</div>
          <p style="color: #999; font-size: 0.9rem;">{allUsers} peternak aktif</p>
        </div>

        <div class="glass-card">
          <h3>Telur Hari Ini</h3>
          <div class="stat-value">{todayEggs}</div>
          <p style="color: #999; font-size: 0.9rem;">Produksi real-time</p>
        </div>

        <div class="glass-card">
          <h3>Produktivitas</h3>
          <div class="stat-value">{productivity}%</div>
          <p style="color: #999; font-size: 0.9rem;">
            {productivity >= 80 ? 'Sangat Baik!' : 'Dalam target'}
          </p>
        </div>

        <div class="glass-card">
          <h3>File Anda</h3>
          <div class="stat-value">{totalFiles}</div>
          <p style="color: #999; font-size: 0.9rem;">{allFiles} total sistem</p>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="actions-grid">
        <div class="glass-card">
          <h3>Input Data Harian</h3>
          <p style="color: #666; margin-bottom: 1rem;">Update data peternakan hari ini</p>
          <img src="/images/realistic-monitoring-dashboard-ayam.jpg" alt="Ilustrasi input data harian" class="action-thumb" loading="lazy" />
          {canInput ? <a href="/input-data" class="btn btn-primary">Input Sekarang</a> : <span class="btn btn-secondary" style="opacity:0.6; cursor:not-allowed;">View-only</span>}
        </div>

        <div class="glass-card">
          <h3>Upload Dokumen</h3>
          <p style="color: #666; margin-bottom: 1rem;">Unggah foto atau laporan peternakan</p>
          <img src="/images/realistic-kelola-file-peternakan.jpg" alt="Ilustrasi unggah dokumen" class="action-thumb" loading="lazy" />
          {canUpload ? <a href="/upload" class="btn btn-primary">Upload Sekarang</a> : <span class="btn btn-secondary" style="opacity:0.6; cursor:not-allowed;">View-only</span>}
        </div>

        <div class="glass-card">
          <h3>Lihat Laporan</h3>
          <p style="color: #666; margin-bottom: 1rem;">Analisis data dan laporan bulanan</p>
          <img src="/images/realistic-keamanan-data-peternakan.jpg" alt="Ilustrasi laporan aman" class="action-thumb" loading="lazy" />
          <a href="/laporan" class="btn btn-primary">Buka Laporan</a>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="recent-activity">
        <h2>Aktivitas Terbaru</h2>

        <div class="activity-item">
          <div class="activity-message">File berhasil diunggah</div>
          <div class="activity-time">2 jam yang lalu</div>
        </div>

        <div class="activity-item">
          <div class="activity-message">Laporan produksi diperbarui</div>
          <div class="activity-time">5 jam yang lalu</div>
        </div>

        <div class="activity-item">
          <div class="activity-message">Pengingat pemberian pakan</div>
          <div class="activity-time">1 hari yang lalu</div>
        </div>

        <div class="activity-item">
          <div class="activity-message">Login berhasil</div>
          <div class="activity-time">1 hari yang lalu</div>
        </div>
      </div>
    </div>
  </body>
</html>
