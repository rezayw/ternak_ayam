---
import { randomUUID } from "node:crypto";
import { db } from "@/lib/db";
import "../styles/design-system.css";
import "../styles/upload.css";

const userId = Astro.cookies.get("session")?.value;
if (!userId) {
  return Astro.redirect("/login");
}

const currentUser = await db.user.findUnique({ where: { id: userId } });
if (!currentUser || currentUser.role === "USER") {
  return Astro.redirect("/dashboard");
}

let csrf = Astro.cookies.get("csrf")?.value;
if (!csrf) {
  csrf = randomUUID();
  Astro.cookies.set("csrf", csrf, {
    httpOnly: true,
    sameSite: "strict",
    secure: true,
    path: "/"
  });
}

const showSuccess = Astro.url.searchParams.get("success") === "1";

// Fetch only personal files for this page
const files = await db.file.findMany({
  where: { ownerId: userId },
  orderBy: { id: "desc" }
});

const lastUpload = files[0];
---


<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload File - Ternak Ayam</title>
  </head>
  <body>
    <!-- SVG Icons -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
      <symbol id="icon-file" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
        <polyline points="13 2 13 9 20 9"/>
      </symbol>
      <symbol id="icon-image" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
        <circle cx="8.5" cy="8.5" r="1.5"/>
        <polyline points="21 15 16 10 5 21"/>
      </symbol>
      <symbol id="icon-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </symbol>
      <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"/>
      </symbol>
      <symbol id="icon-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
      </symbol>
    </svg>
    <nav class="nav-shell">
      <div class="nav-brand">
        <img src="/images/logo.png" alt="Ternak Ayam logo" />
        <span>Ternak Ayam</span>
      </div>
      <div class="nav-links">
        <a href="/dashboard">Dashboard</a>
        <a href="/upload" aria-current="page">Dokumen Saya</a>
        <a href="/laporan">Laporan</a>
        {(currentUser.role === 'ADMIN' || currentUser.role === 'SUPERVISOR') && <a href="/documents">Dokumen Tim</a>}
        <form method="POST" action="/api/auth/logout" style="display:inline;">
          <input type="hidden" name="csrf" value={csrf} />
          <button type="submit" class="btn btn-danger">Logout</button>
        </form>
      </div>
    </nav>

    <main class="page">
      <div class="page-header">
        <div>
          <p class="eyebrow">Dokumen Pribadi</p>
          <h1>Upload & Kelola</h1>
          <p>Unggah dokumentasi peternakan Anda. Data hanya terlihat oleh Anda.</p>
        </div>
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-label">Total File</div>
            <div class="stat-value">{files.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Gambar</div>
            <div class="stat-value">{files.filter(f => f.mime.startsWith('image/')).length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Upload Terakhir</div>
            <div class="stat-value">{lastUpload ? lastUpload.filename : 'Belum ada'}</div>
          </div>
        </div>
      </div>

      <div class="layout">
        <div class="panel">
          <div class="header">
            <h2>Upload Dokumen Pribadi</h2>
            <p>PNG, JPEG, WebP (maks 10MB)</p>
            {(currentUser.role === 'ADMIN' || currentUser.role === 'SUPERVISOR') && (
              <p style="margin-top: 0.5rem; font-size: 0.95rem;">
                Butuh melihat dokumen tim? Buka halaman <a href="/documents">Dokumen Tim</a>.
              </p>
            )}
          </div>

      {showSuccess && (
        <div class="success-banner">
          <div class="success-icon"><img src="/images/icon-success.png" alt="success" style="width:32px;height:32px;" /></div>
          <div class="success-content">
            <h3>Upload Berhasil!</h3>
            <p>File Anda telah berhasil diupload dan tersimpan dengan aman.</p>
          </div>
        </div>
      )}

      <form method="post" action="/api/upload" enctype="multipart/form-data" id="uploadForm">
        <input type="hidden" name="csrf" value={csrf} />

        <div class="form-group">
          <label>Pilih File</label>
          <div class="file-input-wrapper">
            <input type="file" id="file" name="file" accept="image/png,image/jpeg,image/webp" required />
            <label for="file" class="file-input-label">
              <span>
                <div class="icon"></div>
                <div class="file-input-text">Klik atau seret file ke sini</div>
                <div class="file-input-hint">PNG, JPEG, WebP (Max 10MB)</div>
              </span>
            </label>
          </div>
          <div id="selectedFile" style="margin-top: 1rem; color: #7b9ff5;"></div>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-primary full-width">Upload</button>
      </form>
        </div>

        <div class="panel subtle">
          <div class="header compact">
            <h2>Tips Keamanan</h2>
            <p>Pastikan nama file mudah dikenali dan sesuai dokumen.</p>
          </div>
          <ul class="tips">
            <li>Gunakan penamaan jelas: tanggal_jenis_dokumen.</li>
            <li>Hindari data sensitif dalam nama file.</li>
            <li>Pastikan ukuran & format sesuai ketentuan.</li>
          </ul>
        </div>
      </div>

      {files.length > 0 && (
        <div class="uploaded-files">
          <div class="files-header">
            <div>
              <h2>File yang Sudah Diupload ({files.length})</h2>
              <p class="muted">Hanya Anda yang dapat melihat dokumen ini.</p>
            </div>
          </div>
          <div class="files-list">
            {files.map((file) => (
              <div class="file-item">
                <div class="file-icon">
                  {file.mime.startsWith('image/') ? (
                    <svg class="icon icon-xl" style="color: #8bb4ff;">
                      <use href="#icon-image"></use>
                    </svg>
                  ) : (
                    <svg class="icon icon-xl" style="color: #c9c9c9;">
                      <use href="#icon-file"></use>
                    </svg>
                  )}
                </div>
                <div class="file-info">
                  <div class="file-name">{file.filename}</div>
                  <div class="file-meta">
                    <span>{file.mime}</span>
                  </div>
                </div>
                <a href={`/api/download/${file.id}`} class="btn btn-secondary" download style="display: inline-flex; align-items: center; gap: 6px;">
                  <svg class="icon" style="color: currentColor;">
                    <use href="#icon-download"></use>
                  </svg>
                  Download
                </a>
              </div>
            ))}
          </div>
        </div>
      )}

      {files.length === 0 && (
        <div class="empty-state">
          <svg class="icon" style="width: 4rem; height: 4rem; color: #949494; margin-bottom: 0.75rem;">
            <use href="#icon-folder"></use>
          </svg>
          <p class="muted">Belum ada dokumen. Mulai dengan mengunggah file pertama Anda.</p>
        </div>
      )}

      <div class="info-box">
        <h3>Langkah Selanjutnya:</h3>
        <ul style="list-style: none; padding-left: 0;">
          <li style="display: flex; align-items: start; gap: 0.5rem; margin-bottom: 0.5rem;">
            <svg class="icon" style="color: #309875; flex-shrink: 0; margin-top: 2px;">
              <use href="#icon-check"></use>
            </svg>
            <span>File Anda sudah tersimpan dengan aman</span>
          </li>
          <li style="display: flex; align-items: start; gap: 0.5rem; margin-bottom: 0.5rem;">
            <svg class="icon" style="color: #3cffd0; flex-shrink: 0; margin-top: 2px;">
              <use href="#icon-check"></use>
            </svg>
            <span>Lihat statistik peternakan di <a href="/dashboard">Dashboard</a></span>
          </li>
          <li>Upload lebih banyak dokumentasi jika diperlukan</li>
          <li>Kelola akun di halaman <a href="/dashboard">Dashboard</a></li>
        </ul>
      </div>

      <div class="back-link">
        <a href="/dashboard">‚Üê Kembali ke Dashboard</a>
      </div>
    </main>

    <script>
      const fileInput = document.getElementById('file');
      const selectedFile = document.getElementById('selectedFile');
      const form = document.getElementById('uploadForm');
      const submitBtn = document.getElementById('submitBtn');

      fileInput?.addEventListener('change', (e) => {
        const file = (e.target as HTMLInputElement).files?.[0];
        if (file) {
          selectedFile.textContent = `File dipilih: ${file.name}`;
        }
      });

      form?.addEventListener('submit', (e) => {
        submitBtn.textContent = 'Uploading...';
        submitBtn.disabled = true;
      });
    </script>
  </body>
</html>