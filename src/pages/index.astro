---
import type { APIRoute } from "astro";
import { randomUUID } from "node:crypto";
import { db } from "@/lib/db";
import "../styles/index.css";

// Check if user is logged in
const cookies = Astro.cookies;
const sessionId = cookies.get("session")?.value;

let csrf = Astro.cookies.get("csrf")?.value;
if (!csrf) {
  csrf = randomUUID();
  Astro.cookies.set("csrf", csrf, {
    httpOnly: true,
    sameSite: "strict",
    secure: true,
    path: "/"
  });
}

const isLoggedIn = !!sessionId;
const currentUser = sessionId
  ? await db.user.findUnique({ where: { id: sessionId }, select: { role: true, email: true } })
  : null;
const role = currentUser?.role || "USER";
---

<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ternak Ayam - Sistem Manajemen Peternakan Ayam</title>
    <title>Ternak Ayam - Sistem Manajemen Peternakan Ayam</title>
  </head>
  <body>
    <!-- Navigation -->
    <nav>
      <div class="nav-brand">
        <img src="/images/logo.png" alt="Ternak Ayam logo" />
        <span>Ternak Ayam</span>
      </div>
      <div class="nav-links">
        {isLoggedIn ? (
          <>
            <a href="/dashboard">Dashboard</a>
            {role !== "USER" && (
              <>
                <a href="/upload">Dokumen Saya</a>
                {(role === "ADMIN" || role === "SUPERVISOR") && <a href="/documents">Dokumen Tim</a>}
              </>
            )}
            <form method="POST" action="/api/auth/logout">
              <input type="hidden" name="csrf" value={csrf} />
              <button type="submit" class="btn btn-primary">Logout</button>
            </form>
          </>
        ) : (
          <>
            <a href="/login">Login</a>
            <a href="/register" class="btn btn-primary">Daftar</a>
          </>
        )}
      </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero">
      <div class="hero-content">
        <h1>Ternak Ayam</h1>
        <p>Sistem Manajemen Peternakan Ayam Modern</p>
        <p style="font-size: 1rem; opacity: 0.9;">
          Kelola peternakan ayam Anda dengan lebih efisien dan produktif
        </p>
        <div class="hero-buttons">
          {isLoggedIn ? (
            <div style="display:flex; gap:0.75rem; align-items:center; flex-wrap: wrap;">
              <a href="/dashboard" class="btn btn-light">Buka Dashboard</a>
              <span class="role-pill">Role: {role}</span>
              {role === "USER" && <span class="role-note">Akses baca saja</span>}
              {role !== "USER" && (
                <div style="display:flex; gap:0.5rem; flex-wrap: wrap; align-items:center;">
                  <a href="/upload" class="btn btn-secondary">Dokumen Saya</a>
                  {(role === "ADMIN" || role === "SUPERVISOR") && <a href="/documents" class="btn btn-secondary" style="background:#1f2a44;">Dokumen Tim</a>}
                </div>
              )}
            </div>
          ) : (
            <>
              <a href="/login" class="btn btn-light">Login Sekarang</a>
              <a href="/register" class="btn btn-secondary">Buat Akun Baru</a>
            </>
          )}
        </div>
      </div>
      <div class="hero-visual">
        <img src="/images/hero-realistic-peternakan-ayam.jpg" alt="Ilustrasi peternakan ayam modern" loading="lazy" />
        <div class="hero-badge">Real-time insight, keamanan data, multi-user</div>
      </div>
    </div>

    <!-- Features -->
    {!isLoggedIn && (
      <div class="features">
        <div class="glass-card">
          <img src="/images/monitoring.png" alt="Monitoring stok" class="feature-illustration" />
          <h3>Monitoring Stok</h3>
          <p>
            Pantau jumlah ayam, kesehatan, dan produktivitas secara real-time
            dengan dashboard interaktif.
          </p>
        </div>
        <div class="glass-card">
          <img src="/images/kelola_file.png" alt="Kelola file" class="feature-illustration" />
          <h3>Kelola File</h3>
          <p>
            Upload dan kelola dokumen penting seperti laporan, foto, dan data
            penjualan dengan mudah.
          </p>
        </div>
        <div class="glass-card">
          <img src="/images/multiuser.png" alt="Multi user" class="feature-illustration" />
          <h3>Multi User</h3>
          <p>
            Role: Admin (full), Supervisor (approve/pin/lock), Staff (input & komentar pending), User (baca saja).
          </p>
        </div>
        <div class="glass-card">
          <img src="/images/keamananterjamin.png" alt="Keamanan terjamin" class="feature-illustration" />
          <h3>Keamanan Terjamin</h3>
          <p>
            Proteksi data dengan enkripsi password dan CSRF protection untuk
            keamanan maksimal.
          </p>
        </div>
      </div>
    )}
  </body>
</html>
