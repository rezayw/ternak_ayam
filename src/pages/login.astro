---
import { randomUUID } from "node:crypto";
import { createCaptcha } from "@/lib/captcha";
import "../styles/design-system.css";
import "../styles/login.css";

let csrf = Astro.cookies.get("csrf")?.value;
if (!csrf) {
  csrf = randomUUID();
  Astro.cookies.set("csrf", csrf, {
    httpOnly: true,
    sameSite: "strict",
    secure: true,
    path: "/"
  });
}

const { question: captchaQuestion, token: captchaToken } = createCaptcha();
Astro.cookies.set("captcha", captchaToken, {
  httpOnly: true,
  sameSite: "strict",
  secure: true,
  path: "/",
  maxAge: 300
});
---

<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - Ternak Ayam</title>
  </head>
  <body>
    <div class="auth-shell">
      <div class="auth-visual">
        <img src="/images/auth-illustration.png" alt="Ilustrasi keamanan login Ternak Ayam" loading="lazy" />
        <div class="auth-caption">Akses aman, data ternak terjaga</div>
      </div>

      <div class="container auth-card">
        <div class="header">
          <h1>Login</h1>
          <p>Masuk ke akun Ternak Ayam Anda</p>
        </div>

        <form method="post" action="/api/auth/login" id="loginForm">
          <input type="hidden" name="csrf" value={csrf} />

          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" placeholder="contoh@email.com" required />
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" placeholder="••••••••" required />
          </div>

          <div class="form-group">
            <label for="captcha">Captcha: {captchaQuestion}</label>
            <input type="text" id="captcha" name="captcha" placeholder="Jawaban" required />
          </div>

          <div id="statusMessage" style="display:none; padding: 12px; border-radius: 8px; margin-bottom: 1rem;"></div>

          <button type="submit">Login</button>
        </form>

        <div class="footer">
          Belum punya akun? <a href="/register">Daftar di sini</a>
        </div>
      </div>
    </div>

    <script>
      document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target as HTMLFormElement;
        const formData = new FormData(form);
        const statusDiv = document.getElementById('statusMessage');

        try {
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            window.location.href = '/dashboard';
          } else {
            const text = await response.text();
            
            if (statusDiv) {
              if (text === 'PENDING_APPROVAL') {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#fff4e5';
                statusDiv.style.border = '1px solid #ffb84d';
                statusDiv.style.color = '#8b5a00';
                statusDiv.innerHTML = '<svg style="width:20px;height:20px;vertical-align:middle;stroke:#8b5a00;stroke-width:2;fill:none;margin-right:8px;"><circle cx="10" cy="10" r="8"/><polyline points="10 5 10 10 13 12"/></svg><strong>Akun menunggu approval</strong><br>Admin sedang mereview pendaftaran Anda. Silakan coba lagi nanti.';
              } else if (text === 'ACCOUNT_REJECTED') {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#ffeaea';
                statusDiv.style.border = '1px solid #ffc0c0';
                statusDiv.style.color = '#b40000';
                statusDiv.innerHTML = '<svg style="width:20px;height:20px;vertical-align:middle;stroke:#b40000;stroke-width:2;fill:none;margin-right:8px;"><circle cx="10" cy="10" r="8"/><line x1="13" y1="7" x2="7" y2="13"/><line x1="7" y1="7" x2="13" y2="13"/></svg><strong>Akun ditolak</strong><br>Pendaftaran Anda tidak disetujui. Hubungi admin untuk informasi lebih lanjut.';
              } else {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#ffeaea';
                statusDiv.style.border = '1px solid #ffc0c0';
                statusDiv.style.color = '#b40000';
                statusDiv.textContent = 'Email atau password salah, atau captcha tidak valid.';
              }
            }
          }
        } catch (err) {
          if (statusDiv) {
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#ffeaea';
            statusDiv.style.border = '1px solid #ffc0c0';
            statusDiv.style.color = '#b40000';
            statusDiv.textContent = 'Terjadi kesalahan. Coba lagi.';
          }
        }
      });
    </script>
  </body>
</html>