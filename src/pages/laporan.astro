---
import { randomUUID } from "node:crypto";
import { db } from "@/lib/db";
import "../styles/design-system.css";
import "../styles/laporan.css";

const userId = Astro.cookies.get("session")?.value;

let csrf = Astro.cookies.get("csrf")?.value;
if (!csrf) {
  csrf = randomUUID();
  Astro.cookies.set("csrf", csrf, {
    httpOnly: true,
    sameSite: "strict",
    secure: true,
    path: "/"
  });
}

if (!userId) {
  return Astro.redirect("/login");
}

// Fetch user & role
const user = await db.user.findUnique({
  where: { id: userId },
  select: { id: true, role: true }
});

const role = user?.role ?? "USER";
const isModerator = role === "ADMIN" || role === "SUPERVISOR";

// Allowed users for drilldown
const accessibleUsers = role === "ADMIN"
  ? await db.user.findMany({ select: { id: true, email: true, role: true }, orderBy: { email: "asc" } })
  : role === "SUPERVISOR"
    ? await db.user.findMany({
        where: { OR: [{ id: userId }, { role: "STAFF" }] },
        select: { id: true, email: true, role: true },
        orderBy: { email: "asc" }
      })
    : await db.user.findMany({ where: { id: userId }, select: { id: true, email: true, role: true } });

const accessibleUserIds = accessibleUsers.map(u => u.id);

const selectedUserParam = Astro.url.searchParams.get("userId");
const targetUserId = selectedUserParam && accessibleUserIds.includes(selectedUserParam) ? selectedUserParam : null;
const isAggregateView = !targetUserId;

// Scope filters per role or per selected user
const farmWhere = isAggregateView
  ? (role === "ADMIN"
      ? {}
      : role === "SUPERVISOR"
        ? { OR: [{ userId }, { user: { role: "STAFF" } }] }
        : { userId })
  : { userId: targetUserId };

const fileWhere = isAggregateView
  ? (role === "ADMIN"
      ? {}
      : role === "SUPERVISOR"
        ? { OR: [{ ownerId: userId }, { owner: { role: "STAFF" } }] }
        : { ownerId: userId })
  : { ownerId: targetUserId };

// Files scoped by view
const files = await db.file.findMany({
  where: fileWhere,
  orderBy: { id: "desc" }
});
const totalFiles = files.length;
const imageFiles = files.filter(f => f.mime.startsWith('image/')).length;

// User/system counts (files scoped to current view)
const allUsers = await db.user.count();
const allFiles = await db.file.count({ where: fileWhere });

// GET LATEST INPUT DATA (scoped by role)
const latestFarmData = await db.farmData.findFirst({
  where: farmWhere,
  orderBy: { date: "desc" }
});

// GET FARM DATA for historical analysis (scoped by role)
const allFarmData = await db.farmData.findMany({
  where: farmWhere,
  orderBy: { date: "asc" }
});

// ============= REAL STATISTICS FROM DATABASE =============
// Total ayam: aggregate dari SEMUA user atau latest user data
const totalChickensFromAll = allFarmData.reduce((sum, data) => sum + data.totalChickens, 0);
const totalChickens = latestFarmData?.totalChickens || 0;
const currentEggs = latestFarmData?.eggsToday || 0;

// Hitung kesehatan REAL dari data (bukan formula dummy)
const healthScore = latestFarmData ? 
  (latestFarmData.healthyChickens && latestFarmData.totalChickens > 0
    ? Math.floor((latestFarmData.healthyChickens / latestFarmData.totalChickens) * 100)
    : 0)
  : 0;

// Biaya REAL dari database (bukan kalkulasi dummy)
const totalFeedCost = latestFarmData?.feedCost ? Number(latestFarmData.feedCost) : 0;
const medicineCost = latestFarmData?.medicineCost ? Number(latestFarmData.medicineCost) : 0;
const maintenanceCost = latestFarmData?.maintenanceCost ? Number(latestFarmData.maintenanceCost) : 0;
const totalCost = totalFeedCost + medicineCost + maintenanceCost;

// ============= GENERATE MONTHLY DATA FROM DATABASE =============
const now = new Date();
const monthlyData = [];

// Group farm data by month
const monthlyGroups = new Map<string, any[]>();
allFarmData.forEach(data => {
  const dataDate = new Date(data.date);
  const monthKey = `${dataDate.getFullYear()}-${String(dataDate.getMonth() + 1).padStart(2, '0')}`;
  if (!monthlyGroups.has(monthKey)) {
    monthlyGroups.set(monthKey, []);
  }
  monthlyGroups.get(monthKey)!.push(data);
});

for (let i = 5; i >= 0; i--) {
  const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
  const monthName = date.toLocaleDateString('id-ID', { month: 'short' });
  const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
  
  const monthData = monthlyGroups.get(monthKey) || [];
  
  // Aggregate REAL data dari bulan tersebut
  const totalProduction = monthData.reduce((sum, d) => sum + d.eggsToday, 0);
  const avgHealth = monthData.length > 0
    ? Math.floor(monthData.reduce((sum, d) => {
        const h = d.healthyChickens && d.totalChickens > 0 
          ? (d.healthyChickens / d.totalChickens) * 100 
          : 0;
        return sum + h;
      }, 0) / monthData.length)
    : 0;
  
  monthlyData.push({
    month: monthName,
    production: totalProduction,
    health: avgHealth,
    dataCount: monthData.length
  });
}

const currentMonth = monthlyData[monthlyData.length - 1];
const maxProduction = Math.max(1, ...monthlyData.map((m) => m.production));

// Summaries per user (for dropdown/table)
const farmDataForTable = await db.farmData.findMany({
  where: { userId: { in: accessibleUserIds } },
  orderBy: { date: "desc" }
});

const fileDataForTable = await db.file.findMany({
  where: { ownerId: { in: accessibleUserIds } },
  select: { ownerId: true, mime: true }
});

const farmAgg = new Map<string, { production: number; healthSum: number; healthCount: number; cost: number }>();
for (const fd of farmDataForTable) {
  const entry = farmAgg.get(fd.userId) || { production: 0, healthSum: 0, healthCount: 0, cost: 0 };
  entry.production += fd.eggsToday;
  if (fd.totalChickens && fd.healthyChickens) {
    entry.healthSum += (fd.healthyChickens / fd.totalChickens) * 100;
    entry.healthCount += 1;
  }
  entry.cost += Number(fd.feedCost || 0) + Number(fd.medicineCost || 0) + Number(fd.maintenanceCost || 0);
  farmAgg.set(fd.userId, entry);
}

const fileAgg = new Map<string, { total: number; images: number }>();
for (const f of fileDataForTable) {
  const entry = fileAgg.get(f.ownerId) || { total: 0, images: 0 };
  entry.total += 1;
  if (f.mime.startsWith("image/")) entry.images += 1;
  fileAgg.set(f.ownerId, entry);
}

const userSummaries = accessibleUsers.map(u => {
  const f = farmAgg.get(u.id) || { production: 0, healthSum: 0, healthCount: 0, cost: 0 };
  const file = fileAgg.get(u.id) || { total: 0, images: 0 };
  const avgHealth = f.healthCount > 0 ? Math.floor(f.healthSum / f.healthCount) : 0;
  return {
    ...u,
    production: f.production,
    avgHealth,
    cost: f.cost,
    files: file.total,
    images: file.images
  };
});

// Get recent activities from files
const recentActivities = files.slice(0, 3).map(file => ({
  icon: '<img src="/images/icon-upload.svg" alt="upload" style="width:20px;height:20px;" />',
  text: `Upload: ${file.filename}`,
  date: 'Baru saja'
}));

// Add login activity
recentActivities.push({
  icon: '<img src="/images/icon-success.png" alt="success" style="width:20px;height:20px;" />',
  text: 'Login ke sistem',
  date: 'Hari ini'
});

let commentThread = null;
let comments = [] as any[];
if (latestFarmData) {
  commentThread = await db.commentThread.findUnique({
    where: {
      resourceType_resourceId: {
        resourceType: "FARM_DATA",
        resourceId: latestFarmData.id
      }
    }
  });

  if (commentThread) {
    comments = await db.comment.findMany({
      where: {
        threadId: commentThread.id,
        ...(isModerator
          ? {}
          : {
              OR: [
                { status: "APPROVED" },
                { authorId: userId }
              ]
            })
      },
      orderBy: { createdAt: "asc" },
      include: {
        author: { select: { id: true, email: true, role: true } }
      }
    });
  }
}

// Jika punya data farm tapi belum ada thread, buat thread baru agar bisa diskusi
if (!commentThread && latestFarmData) {
  commentThread = await db.commentThread.create({
    data: {
      resourceType: "FARM_DATA",
      resourceId: latestFarmData.id,
      createdById: userId
    }
  });
  comments = [];
}

// Fallback: jika farm terbaru belum punya thread, ambil thread FARM_DATA terbaru milik user
if (!commentThread) {
  const farmDataIds = await db.farmData.findMany({
    where: { userId },
    select: { id: true },
    orderBy: { date: "desc" }
  });

  if (farmDataIds.length > 0) {
    commentThread = await db.commentThread.findFirst({
      where: {
        resourceType: "FARM_DATA",
        resourceId: { in: farmDataIds.map((f) => f.id) }
      },
      orderBy: { createdAt: "desc" }
    });

    if (commentThread) {
      comments = await db.comment.findMany({
        where: {
          threadId: commentThread.id,
          ...(isModerator
            ? {}
            : {
                OR: [
                  { status: "APPROVED" },
                  { authorId: userId }
                ]
              })
        },
        orderBy: { createdAt: "asc" },
        include: {
          author: { select: { id: true, email: true, role: true } }
        }
      });
    }
  }
}

// Jika thread ada tapi belum ada komentar, pilih thread user yang sudah punya komentar (paling baru) agar tidak kosong
if (commentThread && comments.length === 0) {
  const farmDataIds = await db.farmData.findMany({
    where: { userId },
    select: { id: true }
  });

  const threadWithComments = await db.commentThread.findFirst({
    where: {
      resourceType: "FARM_DATA",
      resourceId: { in: farmDataIds.map((f) => f.id) },
      comments: { some: {} }
    },
    orderBy: { createdAt: "desc" }
  });

  if (threadWithComments) {
    commentThread = threadWithComments;
    comments = await db.comment.findMany({
      where: {
        threadId: commentThread.id,
        ...(isModerator
          ? {}
          : {
              OR: [
                { status: "APPROVED" },
                { authorId: userId }
              ]
            })
      },
      orderBy: { createdAt: "asc" },
      include: {
        author: { select: { id: true, email: true, role: true } }
      }
    });
  }
}

// Last-resort fallback: hanya untuk moderator, ambil thread FARM_DATA terbaru (global) supaya minimal ada yang tampil
if (!commentThread && isModerator) {
  commentThread = await db.commentThread.findFirst({
    where: { resourceType: "FARM_DATA" },
    orderBy: { createdAt: "desc" }
  });

  if (commentThread) {
    comments = await db.comment.findMany({
      where: {
        threadId: commentThread.id,
        ...(isModerator
          ? {}
          : {
              OR: [
                { status: "APPROVED" },
                { authorId: userId }
              ]
            })
      },
      orderBy: { createdAt: "asc" },
      include: {
        author: { select: { id: true, email: true, role: true } }
      }
    });
  }
}

// Jika thread ada tapi masih kosong (semua path), cari thread ANY yang punya komentar
if (commentThread && comments.length === 0) {
  const threadWithComments = await db.commentThread.findFirst({
    where: {
      resourceType: "FARM_DATA",
      comments: { some: {} }
    },
    orderBy: { createdAt: "desc" }
  });

  if (threadWithComments) {
    commentThread = threadWithComments;
    comments = await db.comment.findMany({
      where: {
        threadId: commentThread.id,
        ...(isModerator
          ? {}
          : {
              OR: [
                { status: "APPROVED" },
                { authorId: userId }
              ]
            })
      },
      orderBy: { createdAt: "asc" },
      include: {
        author: { select: { id: true, email: true, role: true } }
      }
    });
  }
}

let activeResourceId = latestFarmData?.id ?? commentThread?.resourceId ?? null;

// Untuk STAFF: validasi ownership hanya untuk write (posting), bukan read
// Mereka bisa lihat thread farm mereka sendiri dan komentar dari supervisor/admin di farm mereka
let canPostToThread = true;
if (role === "STAFF" && commentThread?.resourceType === "FARM_DATA") {
  const owner = await db.farmData.findUnique({
    where: { id: commentThread.resourceId },
    select: { userId: true }
  });

  // Hanya block posting jika bukan farm milik staff; tetap bisa baca
  if (!owner || owner.userId !== userId) {
    canPostToThread = false;
  }
}

// Build threaded comments
const parseTags = (tagStr: string | null | undefined) => tagStr
  ? tagStr.split(",").map((t) => t.trim()).filter(Boolean)
  : [];

const commentMap = new Map();
const commentTree = [] as any[];
for (const comment of comments) {
  const node = {
    ...comment,
    issueTags: parseTags(comment.issueTag),
    replies: [] as any[],
    attachmentUrl: comment.attachmentPath ? `/api/comments/attachment/${comment.id}` : null
  };
  commentMap.set(comment.id, node);
}

for (const comment of commentMap.values()) {
  if (comment.parentId && commentMap.has(comment.parentId)) {
    commentMap.get(comment.parentId).replies.push(comment);
  } else {
    commentTree.push(comment);
  }
}

// Sort: pinned comments first, then by creation date
commentTree.sort((a, b) => {
  if (a.isPinned && !b.isPinned) return -1;
  if (!a.isPinned && b.isPinned) return 1;
  return new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime();
});

const canPostComment = role !== "USER" && !!commentThread && canPostToThread;
const threadLocked = commentThread?.isLocked ?? false;
const pinnedCommentId = commentThread?.pinnedCommentId ?? null;

// Tag data for filtering
const collectTags = (list: any[]): string[] => list.flatMap((c) => [
  ...(c.issueTags || []),
  ...(c.replies ? collectTags(c.replies) : [])
]);

const allTags = Array.from(new Set(collectTags(commentTree)));
const selectedTag = Astro.url.searchParams.get("tag")?.trim() || null;

const hasTag = (node: any, tag: string): boolean => {
  const tagLower = tag.toLowerCase();
  const selfMatch = (node.issueTags || []).some((t: string) => t.toLowerCase() === tagLower);
  const replyMatch = node.replies ? node.replies.some((r: any) => hasTag(r, tag)) : false;
  return selfMatch || replyMatch;
};

// Filter comment tree by selected tag
const filteredCommentTree = selectedTag
  ? commentTree.filter((c) => hasTag(c, selectedTag))
  : commentTree;
---

<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Laporan - Ternak Ayam</title>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="nav-shell">
      <div class="nav-brand">
        <img src="/images/logo.png" alt="Ternak Ayam logo" />
        <span>Ternak Ayam</span>
      </div>
      <div class="nav-links">
        <a href="/dashboard">Dashboard</a>
        <a href="/input-data">Input Data</a>
        <a href="/upload">Upload</a>
        <a href="/laporan" aria-current="page">Laporan</a>
        <form method="POST" action="/api/auth/logout" style="display: inline;">
          <input type="hidden" name="csrf" value={csrf} />
          <button type="submit" class="btn btn-danger">Logout</button>
        </form>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
      <div class="header">
        <h1>Laporan Peternakan</h1>
        <p>Analisis data dan statistik lengkap peternakan Anda</p>
      </div>

      {!latestFarmData && (
        <div class="empty-state">
          <img src="/images/empty-state-data-ayam.png" alt="Ilustrasi data peternakan belum ada" loading="lazy" />
          <div class="empty-copy">
            <h3>Data belum lengkap</h3>
            <p>Isi data harian terlebih dahulu agar grafik dan laporan lebih akurat.</p>
            <a class="btn btn-primary" href="/input-data">Input sekarang</a>
          </div>
        </div>
      )}

      <!-- Summary Cards -->
      <div class="summary-grid">
        {(role === "ADMIN" || role === "SUPERVISOR") && (
          <div class="glass-card" style="grid-column: 1 / -1; display:flex; align-items:center; gap:0.75rem; flex-wrap: wrap;">
            <form method="GET" style="display:flex; gap:0.5rem; align-items:center; flex-wrap: wrap;">
              <input type="hidden" name="csrf" value={csrf} />
              <label style="color: var(--text-secondary); font-size: 0.95rem;">Lihat laporan:</label>
              <select name="userId" style="padding: 0.5rem 0.75rem; border-radius: 0.6rem; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary); min-width: 200px;">
                <option value="">Semua (agregat)</option>
                {accessibleUsers.map(u => (
                  <option value={u.id} selected={u.id === targetUserId}>{u.email} ({u.role})</option>
                ))}
              </select>
              <button type="submit" class="btn btn-secondary" style="padding: 0.55rem 1rem;">Terapkan</button>
              {!isAggregateView && <span style="color: var(--text-muted); font-size: 0.9rem;">Sedang melihat: {accessibleUsers.find(u => u.id === targetUserId)?.email}</span>}
            </form>
          </div>
        )}

        <div class="glass-card">
          <div class="summary-icon"></div>
          <div class="summary-content">
            <div class="summary-label">Total Ayam Aktif</div>
            <div class="summary-value">{totalChickens}</div>
            <div class="summary-trend up">{allUsers} peternak aktif</div>
          </div>
        </div>

        <div class="glass-card">
          <div class="summary-icon"></div>
          <div class="summary-content">
            <div class="summary-label">Produksi Bulan Ini</div>
            <div class="summary-value">{currentMonth.production}</div>
            <div class="summary-trend up">+{totalFiles} dokumentasi</div>
          </div>
        </div>

        <div class="glass-card">
          <div class="summary-icon"></div>
          <div class="summary-content">
            <div class="summary-label">Kesehatan Ternak</div>
            <div class="summary-value">{currentMonth.health}%</div>
            <div class="summary-trend up">
              {currentMonth.health >= 90 ? 'Kondisi Baik' : 'Perlu Perhatian'}
            </div>
          </div>
        </div>

        <div class="glass-card">
          <div class="summary-icon"></div>
          <div class="summary-content">
            <div class="summary-label">Dokumentasi Anda</div>
            <div class="summary-value">{totalFiles}</div>
            <div class="summary-trend">{imageFiles} gambar, {allFiles} total sistem</div>
          </div>
        </div>
      </div>

      <!-- Production Chart -->
      <div class="report-section">
        <h2>Grafik Produksi 6 Bulan Terakhir</h2>
        <div class="chart-container">
          {monthlyData.map((data) => (
            <div class="chart-bar-wrapper">
              <div class="chart-bar" style={`height: ${Math.max(12, Math.round((data.production / maxProduction) * 220))}px`}>
                <div class="chart-value">{data.production}</div>
              </div>
              <div class="chart-label">{data.month}</div>
            </div>
          ))}
        </div>
      </div>

      {(role === "ADMIN" || role === "SUPERVISOR") && userSummaries.length > 0 && (
        <div class="report-section">
          <h2>Ringkasan Per Pengguna</h2>
          <div class="report-card" style="overflow-x: auto;">
            <table class="table" style="width:100%; border-collapse: collapse; color: var(--text-primary);">
              <thead>
                <tr style="text-align:left; border-bottom: 1px solid var(--border-color);">
                  <th style="padding: 8px 12px;">Pengguna</th>
                  <th style="padding: 8px 12px;">Role</th>
                  <th style="padding: 8px 12px;">Produksi (6 bln)</th>
                  <th style="padding: 8px 12px;">Rata Kesehatan</th>
                  <th style="padding: 8px 12px;">Biaya</th>
                  <th style="padding: 8px 12px;">Dokumen</th>
                </tr>
              </thead>
              <tbody>
                {userSummaries.map(u => (
                  <tr style={`border-bottom: 1px solid var(--border-color); ${u.id === targetUserId ? 'background: rgba(60,255,208,0.06);' : ''}`}>
                    <td style="padding: 8px 12px;">{u.email}</td>
                    <td style="padding: 8px 12px; text-transform: lowercase;">{u.role}</td>
                    <td style="padding: 8px 12px;">{u.production}</td>
                    <td style="padding: 8px 12px;">{u.avgHealth}%</td>
                    <td style="padding: 8px 12px;">Rp {u.cost.toLocaleString('id-ID')}</td>
                    <td style="padding: 8px 12px;">{u.files} file ({u.images} gambar)</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      <!-- Detailed Reports -->
      <div class="reports-grid">
        <div class="report-card">
          <h3>Target vs Realisasi</h3>
          <div class="report-content">
            <div class="progress-item">
              <div class="progress-label">
                <span>Produksi Telur</span>
                <span>{currentMonth.production}/200</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style={`width: ${(currentMonth.production / 200) * 100}%`}></div>
              </div>
            </div>
            <div class="progress-item">
              <div class="progress-label">
                <span>Dokumentasi</span>
                <span>{totalFiles}/20</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style={`width: ${(totalFiles / 20) * 100}%`}></div>
              </div>
            </div>
            <div class="progress-item">
              <div class="progress-label">
                <span>Kesehatan</span>
                <span>{Math.floor((currentMonth.health / 100) * totalChickens)}/{totalChickens}</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style={`width: ${currentMonth.health}%`}></div>
              </div>
            </div>
          </div>
        </div>

        <div class="report-card">
          <h3>Analisis Biaya</h3>
          <div class="report-content">
            <div class="cost-item">
              <span>Pakan ({totalChickens} ayam)</span>
              <span class="cost-value">Rp {totalFeedCost.toLocaleString('id-ID')}</span>
            </div>
            <div class="cost-item">
              <span>Obat & Vitamin</span>
              <span class="cost-value">Rp {medicineCost.toLocaleString('id-ID')}</span>
            </div>
            <div class="cost-item">
              <span>Perawatan Kandang</span>
              <span class="cost-value">Rp {maintenanceCost.toLocaleString('id-ID')}</span>
            </div>
            <div class="cost-item total">
              <span>Total Biaya Real</span>
              <span class="cost-value">Rp {totalCost.toLocaleString('id-ID')}</span>
            </div>
          </div>
        </div>

        <div class="report-card">
          <h3>Riwayat Aktivitas Real</h3>
          <div class="report-content">
            <div class="activity-log">
              {recentActivities.length > 0 ? (
                recentActivities.map((activity) => (
                  <div class="log-item">
                    <div class="log-icon" set:html={activity.icon}></div>
                    <div class="log-text">{activity.text}</div>
                    <div class="log-date">{activity.date}</div>
                  </div>
                ))
              ) : (
                <div class="log-item">
                  <div class="log-icon"><img src="/images/icon-info.png" alt="info" style="width:20px;height:20px;" /></div>
                  <div class="log-text">Belum ada aktivitas</div>
                  <div class="log-date">-</div>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>

      <!-- Discussion & Comments -->
      <div class="report-section">
        <h2>Diskusi & Komentar</h2>

        {allTags.length > 0 && (
          <div style="margin: 0.5rem 0 1rem; display:flex; gap:0.5rem; flex-wrap: wrap; align-items:center;">
            <span style="color: #888; font-size: 0.95rem;">Filter tag:</span>
            <a href="/laporan" class="btn btn-outline" style={`padding: 4px 10px; font-size: 0.85rem; ${!selectedTag ? 'border-color:#3cffd0;color:#0b0f18;background:#3cffd0' : ''}`}>Semua</a>
            {allTags.map((tag) => (
              <a
                href={`/laporan?tag=${encodeURIComponent(tag)}`}
                class="btn btn-outline"
                style={`padding: 4px 10px; font-size: 0.85rem; ${(selectedTag && selectedTag.toLowerCase() === tag.toLowerCase()) ? 'border-color:#3cffd0;color:#0b0f18;background:#3cffd0' : ''}`}
              >
                #{tag}
              </a>
            ))}
          </div>
        )}

        {threadLocked && (
          <div class="success-banner" style="background: #ffeaea; border: 1px solid #ffc0c0;">
            <div class="success-content">
              <h3>Diskusi dikunci oleh Admin</h3>
              <p>Anda hanya bisa membaca komentar.</p>
            </div>
          </div>
        )}

        {filteredCommentTree.length === 0 ? (
          <div class="glass-card">
            <p style="margin: 0;">{selectedTag ? 'Tidak ada komentar dengan tag tersebut.' : 'Belum ada komentar. Mulai diskusi dengan tim Anda.'}</p>
          </div>
        ) : (
          <div class="glass-card" style="display: flex; flex-direction: column; gap: 1rem;">
            {filteredCommentTree.map((comment) => (
              <div class="comment-item" style="border: 1px solid #eee; border-radius: 10px; padding: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                  <div>
                    <strong>{comment.author.email}</strong>
                    <span style="margin-left: 8px; font-size: 0.85rem; color: #777;">{comment.author.role}</span>
                    {comment.isPinned && <span style="margin-left: 8px; color: #c97a00; display: inline-flex; align-items: center; gap: 4px;"><img src="/images/icon-pin.png" alt="pinned" style="width:16px;height:16px;" /> Pinned</span>}
                  </div>
                  <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                    <span style={`font-size: 0.8rem; padding: 2px 8px; border-radius: 999px; ${comment.status === 'APPROVED' ? 'background:#e6f7ed;color:#0f7b45' : comment.status === 'PENDING' ? 'background:#fff4e5;color:#b45d00' : 'background:#ffeaea;color:#b40000'}`}>Status: {comment.status}</span>
                    {(comment.issueTags && comment.issueTags.length > 0) && (
                      <span style="display:flex; gap:0.35rem; flex-wrap: wrap; align-items:center;">
                        {comment.issueTags.map((tag) => (
                          <a href={`/laporan?tag=${encodeURIComponent(tag)}`} style="font-size: 0.8rem; padding: 2px 8px; border-radius: 999px; background:#e7e9ff; color:#1f2a44; text-decoration:none;">#{tag}</a>
                        ))}
                      </span>
                    )}
                  </div>
                </div>

                <p style="margin: 0.5rem 0; white-space: pre-wrap;">{comment.content}</p>

                <div style="display:flex; gap:0.75rem; align-items:center; flex-wrap: wrap; font-size: 0.9rem; color: #666;">
                  <span>{new Date(comment.createdAt).toLocaleString('id-ID')}</span>
                  {comment.isEdited && <span>(edited)</span>}
                  {comment.attachmentUrl && (
                    <a href={comment.attachmentUrl} style="display: inline-flex; align-items: center; gap: 4px;"><img src="/images/icon-attachment.png" alt="attachment" style="width:16px;height:16px;" /> Lampiran</a>
                  )}
                </div>

                {(role !== "USER") && (
                  <div style="margin-top: 0.5rem; display:flex; gap:0.5rem; flex-wrap: wrap;">
                    {((role === "ADMIN") || (role === "SUPERVISOR" && (comment.author.role === "STAFF" || comment.author.role === "SUPERVISOR")) || (comment.authorId === userId)) && (
                      <form method="POST" action="/api/comments/delete">
                        <input type="hidden" name="csrf" value={csrf} />
                        <input type="hidden" name="commentId" value={comment.id} />
                        <input type="hidden" name="redirectTo" value="/laporan" />
                        <button type="submit" class="btn btn-danger" style="padding: 4px 10px; font-size: 0.85rem;">Hapus</button>
                      </form>
                    )}

                    {isModerator && comment.status === "PENDING" && (
                      <form method="POST" action="/api/comments/update" style="display:inline;">
                        <input type="hidden" name="csrf" value={csrf} />
                        <input type="hidden" name="commentId" value={comment.id} />
                        <input type="hidden" name="action" value="status" />
                        <input type="hidden" name="status" value="APPROVED" />
                        <input type="hidden" name="redirectTo" value="/laporan" />
                        <button type="submit" class="btn btn-primary" style="padding: 4px 10px; font-size: 0.85rem;">Approve</button>
                      </form>
                    )}

                    {role === "ADMIN" && (
                      <form method="POST" action="/api/comments/update" style="display:inline;">
                        <input type="hidden" name="csrf" value={csrf} />
                        <input type="hidden" name="commentId" value={comment.id} />
                        <input type="hidden" name="action" value="pin" />
                        <input type="hidden" name="redirectTo" value="/laporan" />
                        <button type="submit" class="btn btn-secondary" style="padding: 4px 10px; font-size: 0.85rem;">{comment.id === pinnedCommentId ? 'Unpin' : 'Pin'}</button>
                      </form>
                    )}
                  </div>
                )}

                {(role !== "USER") && !threadLocked && !!commentThread && comment.threadId === commentThread.id && (
                  <div style="margin-top: 0.75rem;">
                    <form method="POST" action="/api/comments/create" enctype="multipart/form-data" style="display:flex; flex-direction: column; gap: 0.5rem;">
                      <input type="hidden" name="csrf" value={csrf} />
                      <input type="hidden" name="resourceType" value="FARM_DATA" />
                      <input type="hidden" name="resourceId" value={commentThread.resourceId} />
                      <input type="hidden" name="parentId" value={comment.id} />
                      <input type="hidden" name="redirectTo" value="/laporan" />
                      <label style="width:100%;">
                        <span style="display:block; margin-bottom: 4px; font-size: 0.9rem; color: #555;">Balas komentar ini</span>
                        <textarea name="content" rows={2} required placeholder="Tulis balasan..." style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;"></textarea>
                      </label>
                      <label style="font-size: 0.9rem; color: #555; display:flex; gap:0.5rem; align-items:center;">
                        <span>Lampiran (opsional)</span>
                        <input type="file" name="attachment" accept="image/png,image/jpeg,image/webp" />
                      </label>
                      <div style="display:flex; gap:0.5rem; align-items:center;">
                        <button type="submit" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.9rem;">Kirim Balasan</button>
                        {role === "STAFF" && <span style="font-size:0.85rem; color:#b45d00;">Balasan menunggu approval.</span>}
                      </div>
                    </form>
                  </div>
                )}

                {comment.replies.length > 0 && (
                  <div style="border-left: 2px solid #eee; margin-top: 1rem; padding-left: 1rem; display: flex; flex-direction: column; gap: 0.75rem;">
                    {comment.replies.map((reply) => (
                      <div style="border: 1px solid #f1f1f1; border-radius: 8px; padding: 0.75rem;">
                        <div style="display:flex; justify-content: space-between; gap: 0.5rem; flex-wrap: wrap; align-items:center;">
                          <div>
                            <strong>{reply.author.email}</strong>
                            <span style="margin-left: 8px; font-size: 0.85rem; color: #777;">{reply.author.role}</span>
                          </div>
                          <div style="display:flex; gap:0.4rem; align-items:center; flex-wrap: wrap;">
                            <span style={`font-size: 0.8rem; padding: 2px 8px; border-radius: 999px; ${reply.status === 'APPROVED' ? 'background:#e6f7ed;color:#0f7b45' : reply.status === 'PENDING' ? 'background:#fff4e5;color:#b45d00' : 'background:#ffeaea;color:#b40000'}`}>Status: {reply.status}</span>
                            {(reply.issueTags && reply.issueTags.length > 0) && (
                              <span style="display:flex; gap:0.35rem; flex-wrap: wrap; align-items:center;">
                                {reply.issueTags.map((tag) => (
                                  <a href={`/laporan?tag=${encodeURIComponent(tag)}`} style="font-size: 0.8rem; padding: 2px 8px; border-radius: 999px; background:#e7e9ff; color:#1f2a44; text-decoration:none;">#{tag}</a>
                                ))}
                              </span>
                            )}
                          </div>
                        </div>
                        <p style="margin: 0.5rem 0; white-space: pre-wrap;">{reply.content}</p>
                        <div style="display:flex; gap:0.75rem; align-items:center; flex-wrap: wrap; font-size: 0.9rem; color: #666;">
                          <span>{new Date(reply.createdAt).toLocaleString('id-ID')}</span>
                          {reply.isEdited && <span>(edited)</span>}
                          {reply.attachmentPath && <a href={`/api/comments/attachment/${reply.id}`} style="display: inline-flex; align-items: center; gap: 4px;"><img src="/images/icon-attachment.png" alt="attachment" style="width:16px;height:16px;" /> Lampiran</a>}
                        </div>

                        {(role !== "USER") && (
                          <div style="margin-top: 0.5rem; display:flex; gap:0.5rem; flex-wrap: wrap;">
                            {isModerator && reply.status === "PENDING" && (
                              <form method="POST" action="/api/comments/update" style="display:inline;">
                                <input type="hidden" name="csrf" value={csrf} />
                                <input type="hidden" name="commentId" value={reply.id} />
                                <input type="hidden" name="action" value="status" />
                                <input type="hidden" name="status" value="APPROVED" />
                                <input type="hidden" name="redirectTo" value="/laporan" />
                                <button type="submit" class="btn btn-primary" style="padding: 4px 10px; font-size: 0.85rem;">Approve</button>
                              </form>
                            )}

                            {isModerator && reply.status === "PENDING" && (
                              <form method="POST" action="/api/comments/update" style="display:inline;">
                                <input type="hidden" name="csrf" value={csrf} />
                                <input type="hidden" name="commentId" value={reply.id} />
                                <input type="hidden" name="action" value="status" />
                                <input type="hidden" name="status" value="REJECTED" />
                                <input type="hidden" name="redirectTo" value="/laporan" />
                                <button type="submit" class="btn btn-danger" style="padding: 4px 10px; font-size: 0.85rem;">Reject</button>
                              </form>
                            )}

                            {((role === "ADMIN") || (role === "SUPERVISOR" && (reply.author.role === "STAFF" || reply.author.role === "SUPERVISOR")) || (reply.authorId === userId)) && (
                              <form method="POST" action="/api/comments/delete">
                                <input type="hidden" name="csrf" value={csrf} />
                                <input type="hidden" name="commentId" value={reply.id} />
                                <input type="hidden" name="redirectTo" value="/laporan" />
                                <button type="submit" class="btn btn-danger" style="padding: 4px 10px; font-size: 0.85rem;">Hapus</button>
                              </form>
                            )}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        )}

        {canPostComment ? (
          <div class="glass-card" style="margin-top: 1rem;">
            <h3 style="margin-top: 0;">Tambah Komentar</h3>
            <form method="POST" action="/api/comments/create" enctype="multipart/form-data" style="display:flex; flex-direction: column; gap: 0.75rem;">
              <input type="hidden" name="csrf" value={csrf} />
              <input type="hidden" name="resourceType" value="FARM_DATA" />
              <input type="hidden" name="resourceId" value={activeResourceId} />
              <input type="hidden" name="redirectTo" value="/laporan" />
              <label>
                <span style="display:block; margin-bottom: 4px;">Komentar</span>
                <textarea name="content" rows={3} required placeholder="Tulis komentar, insight, atau instruksi..." style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;"></textarea>
              </label>
              <label>
                <span style="display:block; margin-bottom: 4px;">Tag (opsional, pisahkan dengan koma)</span>
                <input type="text" name="issueTag" placeholder="Contoh: ayam, kebersihan, pakan" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;" />
              </label>
              <label>
                <span style="display:block; margin-bottom: 4px;">Lampiran Foto (png/jpg/webp)</span>
                <input type="file" name="attachment" accept="image/png,image/jpeg,image/webp" />
              </label>
              <div style="font-size: 0.9rem; color: #666;">
                {role === "STAFF" ? "Komentar Anda akan menunggu approval supervisor." : "Komentar langsung tampil (kecuali dikunci)."}
              </div>
              <div style="display:flex; gap:0.75rem;">
                <button type="submit" class="btn btn-primary">Kirim</button>
              </div>
            </form>
            {role === "ADMIN" && commentThread && (
              <form method="POST" action="/api/comments/update" style="margin-top: 0.75rem;">
                <input type="hidden" name="csrf" value={csrf} />
                <input type="hidden" name="commentId" value={commentThread.pinnedCommentId || (commentTree[0]?.id ?? "") } />
                <input type="hidden" name="action" value="lock" />
                <input type="hidden" name="locked" value={threadLocked ? "false" : "true"} />
                <input type="hidden" name="redirectTo" value="/laporan" />
                <button type="submit" class="btn btn-secondary" style="background: #222;">{threadLocked ? "Unlock Diskusi" : "Lock Diskusi"}</button>
              </form>
            )}
          </div>
        ) : (
          <p style="margin-top: 1rem; color: #666;">Anda hanya dapat melihat komentar.</p>
        )}
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="btn btn-secondary" onclick="window.print()">
          Cetak Laporan
        </button>
        <button class="btn btn-primary" onclick="alert('Fitur export akan segera tersedia')">
          Export PDF
        </button>
        <a href="/dashboard" class="btn btn-outline">
          ‚Üê Kembali ke Dashboard
        </a>
      </div>
    </div>
  </body>
</html>
