---
import { randomUUID } from "node:crypto";
import { db } from "@/lib/db";
import "../styles/design-system.css";
import "../styles/input-data.css";

const userId = Astro.cookies.get("session")?.value;
if (!userId) {
  return Astro.redirect("/login");
}

const currentUser = await db.user.findUnique({ where: { id: userId } });
if (!currentUser || currentUser.role === "USER") {
  return Astro.redirect("/dashboard");
}

let csrf = Astro.cookies.get("csrf")?.value;
if (!csrf) {
  csrf = randomUUID();
  Astro.cookies.set("csrf", csrf, {
    httpOnly: true,
    sameSite: "strict",
    secure: true,
    path: "/"
  });
}

const showSuccess = Astro.url.searchParams.get("success") === "1";

// Get latest data for prefill
const latestData = await db.farmData.findFirst({
  where: { userId },
  orderBy: { date: "desc" }
});
---

<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Input Data - Ternak Ayam</title>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="nav-shell">
      <div class="nav-brand">
        <img src="/images/logo.png" alt="Ternak Ayam logo" />
        <span>Ternak Ayam</span>
      </div>
      <div class="nav-links">
        <a href="/dashboard">Dashboard</a>
        <a href="/input-data" aria-current="page">Input Data</a>
        <a href="/upload">Upload</a>
        <a href="/laporan">Laporan</a>
        <form method="POST" action="/api/auth/logout" style="display: inline;">
          <input type="hidden" name="csrf" value={csrf} />
          <button type="submit" class="btn btn-danger">Logout</button>
        </form>
      </div>
    </nav>

    <div class="container">
      <div class="header">
        <h1>Input Data Peternakan</h1>
        <p>Update data harian peternakan ayam Anda</p>
      </div>

      {showSuccess && (
        <div class="success-banner">
          <div class="success-icon"></div>
          <div class="success-content">
            <h3>Data Berhasil Disimpan!</h3>
            <p>Data peternakan Anda telah diupdate. Dashboard akan menampilkan data terbaru.</p>
          </div>
        </div>
      )}

      <form method="post" action="/api/farm/update" id="farmForm" class="styled-form">
        <input type="hidden" name="csrf" value={csrf} />

        <div class="form-section">
          <h2>Data Populasi</h2>
          
          <div class="form-group">
            <label for="totalChickens">Jumlah Ayam (Total)</label>
            <input
              type="number"
              id="totalChickens"
              name="totalChickens"
              placeholder="Contoh: 250"
              min="0"
              value={latestData?.totalChickens || ""}
              required
            />
            <div class="hint">Total ayam aktif saat ini</div>
          </div>

          <div class="form-group">
            <label for="healthyChickens">Ayam Sehat</label>
            <input
              type="number"
              id="healthyChickens"
              name="healthyChickens"
              placeholder="Contoh: 240"
              min="0"
              value={latestData?.healthyChickens || ""}
              required
            />
            <div class="hint">Jumlah ayam dalam kondisi sehat</div>
          </div>

          <div class="form-group">
            <label for="eggsToday">Produksi Telur Hari Ini</label>
            <input
              type="number"
              id="eggsToday"
              name="eggsToday"
              placeholder="Contoh: 185"
              min="0"
              required
            />
            <div class="hint">Jumlah telur yang diproduksi hari ini</div>
          </div>
        </div>

        <div class="form-section">
          <h2>Data Biaya</h2>
          
          <div class="form-group">
            <label for="feedCost">Biaya Pakan (Rp)</label>
            <input
              type="number"
              id="feedCost"
              name="feedCost"
              placeholder="Contoh: 500000"
              min="0"
              value={latestData?.feedCost || ""}
              required
            />
            <div class="hint">Biaya pakan hari ini atau rata-rata per hari</div>
          </div>

          <div class="form-group">
            <label for="medicineCost">Biaya Obat & Vitamin (Rp)</label>
            <input
              type="number"
              id="medicineCost"
              name="medicineCost"
              placeholder="Contoh: 150000"
              min="0"
              value={latestData?.medicineCost || ""}
              required
            />
            <div class="hint">Biaya kesehatan dan vitamin</div>
          </div>

          <div class="form-group">
            <label for="maintenanceCost">Biaya Perawatan Kandang (Rp)</label>
            <input
              type="number"
              id="maintenanceCost"
              name="maintenanceCost"
              placeholder="Contoh: 100000"
              min="0"
              value={latestData?.maintenanceCost || ""}
              required
            />
            <div class="hint">Biaya perawatan dan kebersihan kandang</div>
          </div>
        </div>

        <div class="form-section">
          <h2>Catatan Tambahan</h2>
          
          <div class="form-group">
            <label for="notes">Catatan (Opsional)</label>
            <textarea
              id="notes"
              name="notes"
              rows="4"
              placeholder="Contoh: Kondisi cuaca baik, ayam sehat, tidak ada masalah"
            ></textarea>
            <div class="hint">Catatan kondisi atau kejadian khusus hari ini</div>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Simpan Data</button>
          <a href="/dashboard" class="btn btn-outline" style="display: inline-flex; align-items: center; gap: 6px;"><img src="/images/icon-cancel.png" alt="cancel" style="width:16px;height:16px;" /> Batal</a>
        </div>
      </form>

      <div class="info-box">
        <h3>Tips Pengisian Data:</h3>
        <ul>
          <li>âœ… Update data setiap hari untuk laporan yang akurat</li>
          <li>Data yang tersimpan akan otomatis muncul di Dashboard dan Laporan</li>
          <li>Masukkan angka sebenar mungkin untuk analisis yang tepat</li>
          <li>Catatan membantu Anda mengingat kondisi khusus</li>
        </ul>
      </div>
    </div>
  </body>
</html>
