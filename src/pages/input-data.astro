---
import { randomUUID } from "node:crypto";
import { db } from "@/lib/db";
import "../styles/design-system.css";
import "../styles/input-data.css";

const userId = Astro.cookies.get("session")?.value;
if (!userId) {
  return Astro.redirect("/login");
}

const currentUser = await db.user.findUnique({ where: { id: userId } });
if (!currentUser || currentUser.role === "USER") {
  return Astro.redirect("/dashboard");
}

let csrf = Astro.cookies.get("csrf")?.value;
if (!csrf) {
  csrf = randomUUID();
  Astro.cookies.set("csrf", csrf, {
    httpOnly: true,
    sameSite: "strict",
    secure: true,
    path: "/"
  });
}

const showSuccess = Astro.url.searchParams.get("success") === "1";

// Get latest data for prefill
const latestData = await db.farmData.findFirst({
  where: { userId },
  orderBy: { date: "desc" }
});
---

<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Input Data - Ternak Ayam</title>
  </head>
  <body>
    <!-- SVG Icons -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
      <symbol id="icon-check-circle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
        <polyline points="22 4 12 14.01 9 11.01"/>
      </symbol>
      <symbol id="icon-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="16" x2="12" y2="12"/>
        <line x1="12" y1="8" x2="12.01" y2="8"/>
      </symbol>
      <symbol id="icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <polyline points="12 6 12 12 16 14"/>
      </symbol>
      <symbol id="icon-target" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <circle cx="12" cy="12" r="6"/>
        <circle cx="12" cy="12" r="2"/>
      </symbol>
      <symbol id="icon-clipboard" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
      </symbol>
    </svg>

    <!-- Navigation -->
    <nav class="nav-shell">
      <div class="nav-brand">
        <img src="/images/logo.png" alt="Ternak Ayam logo" />
        <span>Ternak Ayam</span>
      </div>
      <div class="nav-links">
        <a href="/dashboard">Dashboard</a>
        <a href="/input-data" aria-current="page">Input Data</a>
        <a href="/upload">Upload</a>
        <a href="/laporan">Laporan</a>
        <form method="POST" action="/api/auth/logout" style="display: inline;">
          <input type="hidden" name="csrf" value={csrf} />
          <button type="submit" class="btn btn-danger">Logout</button>
        </form>
      </div>
    </nav>

    <div class="container">
      <div class="header">
        <h1>Input Data Peternakan</h1>
        <p>Update data harian peternakan ayam Anda</p>
      </div>

      {showSuccess && (
        <div class="success-banner">
          <div class="success-icon"></div>
          <div class="success-content">
            <h3>Data Berhasil Disimpan!</h3>
            <p>Data peternakan Anda telah diupdate. Dashboard akan menampilkan data terbaru.</p>
          </div>
        </div>
      )}

      <form method="post" action="/api/farm/update" id="farmForm" class="styled-form">
        <input type="hidden" name="csrf" value={csrf} />

        <div class="form-section">
          <h2>Data Populasi</h2>
          
          <div class="form-group">
            <label for="totalChickens">Jumlah Ayam (Total)</label>
            <input
              type="number"
              id="totalChickens"
              name="totalChickens"
              placeholder="Contoh: 250"
              min="0"
              value={latestData?.totalChickens || ""}
              required
            />
            <div class="hint">Total ayam aktif saat ini</div>
          </div>

          <div class="form-group">
            <label for="healthyChickens">Ayam Sehat</label>
            <input
              type="number"
              id="healthyChickens"
              name="healthyChickens"
              placeholder="Contoh: 240"
              min="0"
              value={latestData?.healthyChickens || ""}
              required
            />
            <div class="hint">Jumlah ayam dalam kondisi sehat</div>
          </div>

          <div class="form-group">
            <label for="eggsToday">Produksi Telur Hari Ini</label>
            <input
              type="number"
              id="eggsToday"
              name="eggsToday"
              placeholder="Contoh: 185"
              min="0"
              required
            />
            <div class="hint">Jumlah telur yang diproduksi hari ini</div>
          </div>
        </div>

        <div class="form-section">
          <h2>Data Biaya</h2>
          
          <div class="form-group">
            <label for="feedCost">Biaya Pakan (Rp)</label>
            <input
              type="number"
              id="feedCost"
              name="feedCost"
              placeholder="Contoh: 500000"
              min="0"
              value={latestData?.feedCost || ""}
              required
            />
            <div class="hint">Biaya pakan hari ini atau rata-rata per hari</div>
          </div>

          <div class="form-group">
            <label for="medicineCost">Biaya Obat & Vitamin (Rp)</label>
            <input
              type="number"
              id="medicineCost"
              name="medicineCost"
              placeholder="Contoh: 150000"
              min="0"
              value={latestData?.medicineCost || ""}
              required
            />
            <div class="hint">Biaya kesehatan dan vitamin</div>
          </div>

          <div class="form-group">
            <label for="maintenanceCost">Biaya Perawatan Kandang (Rp)</label>
            <input
              type="number"
              id="maintenanceCost"
              name="maintenanceCost"
              placeholder="Contoh: 100000"
              min="0"
              value={latestData?.maintenanceCost || ""}
              required
            />
            <div class="hint">Biaya perawatan dan kebersihan kandang</div>
          </div>
        </div>

        <div class="form-section">
          <h2>Catatan Tambahan</h2>
          
          <div class="form-group">
            <label for="notes">Catatan (Opsional)</label>
            <textarea
              id="notes"
              name="notes"
              rows="4"
              placeholder="Contoh: Kondisi cuaca baik, ayam sehat, tidak ada masalah"
            ></textarea>
            <div class="hint">Catatan kondisi atau kejadian khusus hari ini</div>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Simpan Data</button>
          <a href="/dashboard" class="btn btn-outline" style="display: inline-flex; align-items: center; gap: 6px;"><img src="/images/icon-cancel.png" alt="cancel" style="width:16px;height:16px;" /> Batal</a>
        </div>
      </form>

      <div class="info-box">
        <h3>Tips Pengisian Data:</h3>
        <ul style="list-style: none; padding-left: 0;">
          <li style="display: flex; align-items: start; gap: 0.5rem; margin-bottom: 0.75rem;">
            <svg class="icon" style="color: #309875; flex-shrink: 0; margin-top: 2px;">
              <use href="#icon-check-circle"></use>
            </svg>
            <span>Update data setiap hari untuk laporan yang akurat</span>
          </li>
          <li style="display: flex; align-items: start; gap: 0.5rem; margin-bottom: 0.75rem;">
            <svg class="icon" style="color: #3cffd0; flex-shrink: 0; margin-top: 2px;">
              <use href="#icon-info"></use>
            </svg>
            <span>Data yang tersimpan akan otomatis muncul di Dashboard dan Laporan</span>
          </li>
          <li style="display: flex; align-items: start; gap: 0.5rem; margin-bottom: 0.75rem;">
            <svg class="icon" style="color: #8bb4ff; flex-shrink: 0; margin-top: 2px;">
              <use href="#icon-target"></use>
            </svg>
            <span>Masukkan angka sebenar mungkin untuk analisis yang tepat</span>
          </li>
          <li style="display: flex; align-items: start; gap: 0.5rem;">
            <svg class="icon" style="color: #ffd700; flex-shrink: 0; margin-top: 2px;">
              <use href="#icon-clipboard"></use>
            </svg>
            <span>Catatan membantu Anda mengingat kondisi khusus</span>
          </li>
        </ul>
      </div>
    </div>
  </body>
</html>
